//! ブロックチェーンデータ構造定義
//!
//! このモジュールはブロックチェーンアプリケーション全体で使用される
//! コアデータ構造を定義します。ブロック、トランザクション、
//! ネットワークピアの構造体を含み、ブロックチェーンのデータモデルの
//! 基盤を形成します。

const std = @import("std");

//------------------------------------------------------------------------------
// コアブロックチェーンデータ構造
//------------------------------------------------------------------------------

/// トランザクション情報
/// ブロックチェーン上の価値移転やスマートコントラクトの操作を表現します
pub const Transaction = struct {
    /// 送信者のアドレス
    sender: []const u8,
    /// 受信者のアドレス
    receiver: []const u8,
    /// 送金額
    amount: u64,
    /// トランザクションのタイプ
    /// 0: 通常の送金
    /// 1: スマートコントラクトのデプロイ
    /// 2: スマートコントラクトの呼び出し
    tx_type: u8 = 0,
    /// EVMバイトコード（コントラクトデプロイ時）または呼び出しデータ（コントラクト呼び出し時）
    evm_data: ?[]const u8 = null,
    /// ガス上限
    gas_limit: usize = 1000000,
    /// ガス価格（単位: wei/gas）
    gas_price: u64 = 20000000000, // 20 Gwei
    /// トランザクションの一意識別子
    id: [32]u8 = [_]u8{0} ** 32,
};

/// ブロックチェーン内の単一ブロックを表すブロック構造体
///
/// ブロックは複数のトランザクションを含み、チェーンの一部を形成します。
/// 各ブロックは前のブロックへの暗号的リンクを含み、
/// チェーン構造を作成します。
///
/// フィールド:
///     index: ブロックチェーン内の連続位置
///     timestamp: 作成時刻（Unixタイムスタンプ）
///     prev_hash: 前のブロックのハッシュ（チェーンを作成）
///     transactions: このブロックに含まれるトランザクションのリスト
///     nonce: プルーフオブワークマイニングに使用される値
///     data: ブロックに格納される追加データ
///     hash: このブロックの内容の暗号ハッシュ
///     contracts: コントラクトアドレスとバイトコードのマップ（null可）
pub const Block = struct {
    /// ブロックチェーン内の連続位置（ジェネシスブロックは0から開始）
    index: u32,

    /// Unixタイムスタンプ（エポックからの経過秒数）としての作成時刻
    timestamp: u64,

    /// 前のブロックのハッシュ、チェーン構造を作成
    /// ジェネシスブロックの場合はゼロで埋められる
    prev_hash: [32]u8,

    /// このブロックに含まれるトランザクションのリスト
    transactions: std.ArrayList(Transaction),

    /// プルーフオブワーク要件を満たすためにマイニング中に変更される値
    nonce: u64,

    /// ブロックに格納される追加データ（任意の情報）
    data: []const u8,

    /// このブロックの内容の暗号ハッシュ（SHA-256）
    /// 他のすべてのフィールドに基づいて計算され、難易度要件を満たす必要がある
    hash: [32]u8,

    /// コントラクトアドレスとバイトコードのマップ（null可）
    /// 各ブロックには、そのブロックで新たにデプロイされたコントラクトのコードが含まれる
    /// コントラクトストレージの同期に使用される
    contracts: ?std.StringHashMap([]const u8) = null,
};

//------------------------------------------------------------------------------
// ネットワーク関連構造体
//------------------------------------------------------------------------------

/// 別のノードへの接続を表すネットワークピア構造体
///
/// ピアツーピアネットワーク内の接続されたピアを表します。
/// 各ピアは通信用のアドレスとネットワークストリームを持ちます。
///
/// フィールド:
///     address: ピアのネットワークアドレス
///     stream: データの送受信用のアクティブな接続ストリーム
pub const Peer = struct {
    /// ピアのネットワークアドレス
    address: std.net.Address,

    /// ピアとの通信用のアクティブな接続ストリーム
    stream: std.net.Stream,
};
