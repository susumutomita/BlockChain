# EVM オペコード実装計画

## 概要

このドキュメントでは、実装予定のEVMオペコードとその優先順位を定義します。オペコードは機能グループごとに分類し、各フェーズで実装する内容を明確にします。

## 優先度定義

- **優先度1**: 最小限の機能を実現するために必須（基本算術演算、スタック操作）
- **優先度2**: 基本的なスマートコントラクト実行に必要（メモリ/ストレージ操作、制御フロー）
- **優先度3**: より高度なスマートコントラクト機能に必要（コントラクト間通信、イベント）
- **優先度4**: 完全なEthereum互換性のために必要（より複雑な操作、特殊な命令）

## オペコード一覧と実装優先度

### スタック操作

| オペコード | 説明 | 優先度 | ガスコスト | 実装状況 |
|-----------|------|--------|----------|---------|
| 0x00 (STOP) | 実行を停止 | 1 | 0 | ✅ |
| 0x50 (POP) | スタックから値を取り出し破棄 | 1 | 2 | ✅ |
| 0x5f (PUSH0) | 0値をスタックにプッシュ | 1 | 2 | ⬜️ |
| 0x60 (PUSH1) | 1バイトの値をスタックにプッシュ | 1 | 3 | ✅ |
| 0x61-0x7f (PUSH2-32) | 2-32バイトの値をスタックにプッシュ | 1 | 3-36 | ⬜️ |
| 0x80-0x8f (DUP1-16) | スタック上のn番目の値を複製 | 1 | 3 | ⬜️ |
| 0x90-0x9f (SWAP1-16) | スタック上の1番目とn+1番目の値を交換 | 1 | 3 | ⬜️ |

### 算術演算

| オペコード | 説明 | 優先度 | ガスコスト | 実装状況 |
|-----------|------|--------|----------|---------|
| 0x01 (ADD) | 加算 | 1 | 3 | ✅ |
| 0x02 (MUL) | 乗算 | 1 | 5 | ✅ |
| 0x03 (SUB) | 減算 | 1 | 3 | ✅ |
| 0x04 (DIV) | 符号なし除算 | 1 | 5 | ✅ |
| 0x05 (SDIV) | 符号付き除算 | 2 | 5 | ⬜️ |
| 0x06 (MOD) | 符号なし剰余 | 2 | 5 | ⬜️ |
| 0x07 (SMOD) | 符号付き剰余 | 2 | 5 | ⬜️ |
| 0x08 (ADDMOD) | 加算後剰余 | 2 | 8 | ⬜️ |
| 0x09 (MULMOD) | 乗算後剰余 | 2 | 8 | ⬜️ |
| 0x0a (EXP) | べき乗 | 2 | 10+ | ⬜️ |
| 0x0b (SIGNEXTEND) | 符号拡張 | 2 | 5 | ⬜️ |

### 比較・ビット演算

| オペコード | 説明 | 優先度 | ガスコスト | 実装状況 |
|-----------|------|--------|----------|---------|
| 0x10 (LT) | 未満 | 1 | 3 | ⬜️ |
| 0x11 (GT) | より大きい | 1 | 3 | ⬜️ |
| 0x12 (SLT) | 符号付き未満 | 2 | 3 | ⬜️ |
| 0x13 (SGT) | 符号付きより大きい | 2 | 3 | ⬜️ |
| 0x14 (EQ) | 等しい | 1 | 3 | ⬜️ |
| 0x15 (ISZERO) | ゼロかどうか | 1 | 3 | ⬜️ |
| 0x16 (AND) | ビット論理積 | 1 | 3 | ⬜️ |
| 0x17 (OR) | ビット論理和 | 1 | 3 | ⬜️ |
| 0x18 (XOR) | 排他的論理和 | 1 | 3 | ⬜️ |
| 0x19 (NOT) | ビット否定 | 1 | 3 | ⬜️ |
| 0x1a (BYTE) | バイト取り出し | 2 | 3 | ⬜️ |
| 0x1b (SHL) | 左シフト | 2 | 3 | ⬜️ |
| 0x1c (SHR) | 右シフト | 2 | 3 | ⬜️ |
| 0x1d (SAR) | 算術右シフト | 2 | 3 | ⬜️ |

### ハッシュ

| オペコード | 説明 | 優先度 | ガスコスト | 実装状況 |
|-----------|------|--------|----------|---------|
| 0x20 (SHA3) | Keccak-256ハッシュ | 2 | 30+ | ⬜️ |

### 環境情報

| オペコード | 説明 | 優先度 | ガスコスト | 実装状況 |
|-----------|------|--------|----------|---------|
| 0x30 (ADDRESS) | 現在の実行アカウントのアドレス | 3 | 2 | ⬜️ |
| 0x31 (BALANCE) | アドレスの残高 | 3 | 700 | ⬜️ |
| 0x32 (ORIGIN) | トランザクション発信者 | 3 | 2 | ⬜️ |
| 0x33 (CALLER) | 呼び出し元アドレス | 3 | 2 | ⬜️ |
| 0x34 (CALLVALUE) | 送金されたETH量 | 3 | 2 | ⬜️ |
| 0x35 (CALLDATALOAD) | 呼び出しデータのロード | 2 | 3 | ✅ |
| 0x36 (CALLDATASIZE) | 呼び出しデータのサイズ | 2 | 2 | ⬜️ |
| 0x37 (CALLDATACOPY) | 呼び出しデータのコピー | 2 | 3+ | ⬜️ |
| 0x38 (CODESIZE) | コードサイズ | 2 | 2 | ⬜️ |
| 0x39 (CODECOPY) | コードのコピー | 2 | 3+ | ⬜️ |
| 0x3a (GASPRICE) | ガス価格 | 3 | 2 | ⬜️ |
| 0x3b (EXTCODESIZE) | 外部コードサイズ | 3 | 700+ | ⬜️ |
| 0x3c (EXTCODECOPY) | 外部コードのコピー | 3 | 700+ | ⬜️ |
| 0x3d (RETURNDATASIZE) | 直前の呼び出しの戻りデータサイズ | 3 | 2 | ⬜️ |
| 0x3e (RETURNDATACOPY) | 直前の呼び出しの戻りデータをコピー | 3 | 3+ | ⬜️ |
| 0x3f (EXTCODEHASH) | アカウントのコードハッシュ | 3 | 700+ | ⬜️ |

### ブロック情報

| オペコード | 説明 | 優先度 | ガスコスト | 実装状況 |
|-----------|------|--------|----------|---------|
| 0x40 (BLOCKHASH) | 直近256ブロック中のブロックハッシュ | 3 | 20 | ⬜️ |
| 0x41 (COINBASE) | 現在のブロックのマイナー報酬先アドレス | 3 | 2 | ⬜️ |
| 0x42 (TIMESTAMP) | 現在のブロックのタイムスタンプ | 3 | 2 | ⬜️ |
| 0x43 (NUMBER) | 現在のブロック番号 | 3 | 2 | ⬜️ |
| 0x44 (DIFFICULTY/PREVRANDAO) | 現在のブロックの難易度 | 3 | 2 | ⬜️ |
| 0x45 (GASLIMIT) | 現在のブロックのガス上限 | 3 | 2 | ⬜️ |
| 0x46 (CHAINID) | チェーンID | 3 | 2 | ⬜️ |
| 0x47 (SELFBALANCE) | 自コントラクトの残高 | 3 | 5 | ⬜️ |
| 0x48 (BASEFEE) | 現在のブロックの基本手数料 | 3 | 2 | ⬜️ |
| 0x49 (BLOBHASH) | ブロブハッシュ (EIP-4844) | 4 | 3 | ⬜️ |
| 0x4a (BLOBBASEFEE) | ブロブの基本手数料 | 4 | 2 | ⬜️ |

### メモリ・ストレージ・フロー操作

| オペコード | 説明 | 優先度 | ガスコスト | 実装状況 |
|-----------|------|--------|----------|---------|
| 0x51 (MLOAD) | メモリからロード | 1 | 3+ | ✅ |
| 0x52 (MSTORE) | メモリに保存 | 1 | 3+ | ✅ |
| 0x53 (MSTORE8) | メモリに1バイト保存 | 2 | 3+ | ⬜️ |
| 0x54 (SLOAD) | ストレージからロード | 1 | 800/200/100 | ✅ |
| 0x55 (SSTORE) | ストレージに保存 | 1 | 20000/5000/... | ✅ |
| 0x56 (JUMP) | 無条件ジャンプ | 2 | 8 | ⬜️ |
| 0x57 (JUMPI) | 条件付きジャンプ | 2 | 10 | ⬜️ |
| 0x58 (PC) | プログラムカウンタ | 3 | 2 | ⬜️ |
| 0x59 (MSIZE) | メモリサイズ | 2 | 2 | ⬜️ |
| 0x5a (GAS) | 残りガス | 3 | 2 | ⬜️ |
| 0x5b (JUMPDEST) | ジャンプ先マーカー | 2 | 1 | ⬜️ |

### ログ操作

| オペコード | 説明 | 優先度 | ガスコスト | 実装状況 |
|-----------|------|--------|----------|---------|
| 0xa0 (LOG0) | トピック0でログ記録 | 3 | 375+ | ⬜️ |
| 0xa1 (LOG1) | トピック1でログ記録 | 3 | 750+ | ⬜️ |
| 0xa2 (LOG2) | トピック2でログ記録 | 3 | 1125+ | ⬜️ |
| 0xa3 (LOG3) | トピック3でログ記録 | 3 | 1500+ | ⬜️ |
| 0xa4 (LOG4) | トピック4でログ記録 | 3 | 1875+ | ⬜️ |

### システム操作

| オペコード | 説明 | 優先度 | ガスコスト | 実装状況 |
|-----------|------|--------|----------|---------|
| 0xf0 (CREATE) | 新規コントラクト作成 | 3 | 32000+ | ⬜️ |
| 0xf1 (CALL) | コントラクト呼び出し | 3 | 700+ | ⬜️ |
| 0xf2 (CALLCODE) | コード呼び出し（旧） | 4 | 700+ | ⬜️ |
| 0xf3 (RETURN) | 実行を終了し値を返す | 1 | 0 | ✅ |
| 0xf4 (DELEGATECALL) | 委譲呼び出し | 3 | 700+ | ⬜️ |
| 0xf5 (CREATE2) | 決定的アドレスでコントラクト作成 | 4 | 32000+ | ⬜️ |
| 0xfa (STATICCALL) | 状態変更なしの呼び出し | 3 | 700+ | ⬜️ |
| 0xfd (REVERT) | 実行を終了し状態変更を戻し値を返す | 2 | 0 | ⬜️ |
| 0xff (SELFDESTRUCT) | コントラクト削除 | 4 | 5000+ | ⬜️ |

## 実装フェーズ

### フェーズ1: 最小限のEVM (MVE - Minimum Viable EVM)

以下のオペコードを実装して、基本的な算術演算と単純なコントラクト実行を可能にします：

- 基本制御: STOP, RETURN
- スタック操作: POP, PUSH1-PUSH32, DUP1, SWAP1
- 基本算術: ADD, SUB, MUL, DIV
- メモリ操作: MLOAD, MSTORE
- ストレージ操作: SLOAD, SSTORE
- データアクセス: CALLDATALOAD

### フェーズ2: 制御フローとより多くの演算

- 比較演算: LT, GT, EQ, ISZERO
- ビット演算: AND, OR, XOR, NOT
- 制御フロー: JUMP, JUMPI, JUMPDEST
- 追加メモリ操作: MSTORE8, MSIZE, CALLDATASIZE, CALLDATACOPY
- エラー処理: REVERT

### フェーズ3: 環境情報とブロックチェーン統合

- 環境情報: ADDRESS, BALANCE, ORIGIN, CALLER, CALLVALUE
- ブロック情報: BLOCKHASH, COINBASE, TIMESTAMP, NUMBER, DIFFICULTY, GASLIMIT
- ログ操作: LOG0-LOG4
- 高度なデータ処理: SHA3

### フェーズ4: コントラクト間通信とシステム操作

- 呼び出し操作: CALL, DELEGATECALL, STATICCALL
- コントラクト作成: CREATE, CREATE2
- コード操作: CODESIZE, CODECOPY, EXTCODESIZE, EXTCODECOPY
- 戻り値処理: RETURNDATASIZE, RETURNDATACOPY

### フェーズ5: 完全なEthereum互換性

- 残りの全オペコード
- 最適化とガス計算の精緻化
- 完全なセキュリティ監査

## ガス計算

全てのEVMオペレーションには、実行に必要なリソースに基づいて「ガスコスト」が割り当てられています。ガス計算の主な原則は以下の通りです：

1. **基本操作コスト**: 各命令の基本コスト
2. **メモリ拡張コスト**: メモリが拡張されるたびに追加コスト
3. **ストレージコスト**:
   - 0から非0への変更: 高コスト (20000ガス)
   - 既存値の更新: 中コスト (5000ガス)
   - 非0から0への変更: ガスの返還あり

ガス計算の詳細実装は、Yellow Paperおよび関連するEIPsに厳密に従います。
